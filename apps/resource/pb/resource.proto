syntax = "proto3";

package infraboard.cmdb.resource;
option go_package="github.com/infraboard/cmdb/apps/resource";

import "github.com/infraboard/mcube/pb/page/page.proto";

service Service {
    rpc Search (SearchRequest) returns (ResourceSet);
    rpc QueryTag(QueryTagRequest) returns (TagSet);
    rpc UpdateTag (UpdateTagRequest) returns (Resource);
    rpc UpdateFavorite(UpdateFavoriteRequest) returns (Resource);
}

enum Vendor {
    ALIYUN = 0;
    TENCENT = 1;
    HUAWEI = 2;
    VSPHERE = 3;
    AMAZON = 4;
}

enum Type {
    HOST = 0;
    RDS = 1;
    BILL = 99;
}

// 使用方式
enum UsageMode {
    // 共享使用
    SHARED = 0;
    // 独占使用
    MONOPOLY = 1;
}

message ResourceSet {
    // @gotags: json:"total"
    int64 total = 1;
    // @gotags: json:"items"
    repeated Resource items = 2;
}

message Resource {
    // 资源元数据信息
    // @gotags: json:"base"
    Base base = 1;
    // 资源信息
    // @gotags: json:"information"
    Information information = 2;
    // 资源释放计划
    // @gotags: json:"release_plan"
    ReleasePlan release_plan = 3;
}

// 资源释放计划
message ReleasePlan {
    // 释放原因
    // @gotags: json:"reason"
    string reason = 1;
    // 是否立即释放
    // @gotags: json:"immediately"
    bool immediately = 2;
    // 计划时间
    // @gotags: json:"plan_at"
    int64 plan_at = 3;
    // 执行时间
    // @gotags: json:"exec_at"
    int64 exec_at = 4;
    // 释放前 提前几天通知, 过期后 云商会自动释放的也需要提前通知
    // @gotags: json:"notice_before_days"
    int64 notice_before_days = 5;
    // 资源释放后, 什么时候销毁该数据
    // @gotags: json:"destory_at"
    int64 destory_at = 6;
}

message Base {
    // 全局唯一Id, 直接使用个云商自己的Id
    // @gotags: json:"id" validate:"required"
    string id = 1; 
    // 同步时间
    // @gotags: json:"sync_at"
    int64 sync_at = 2;  
    // 用于同步的凭证ID
    // @gotags: json:"secret_id"
    string secret_id = 3; 
    // 厂商
    // @gotags: json:"vendor"
    Vendor vendor = 4;
    // 资源类型
    // @gotags: json:"resource_type"
    Type resource_type = 5;
    // 地域
    // @gotags: json:"region"
    string region = 6; 
    // 区域
    // @gotags: json:"zone"
    string zone = 7; 
    // 创建时间
    // @gotags: json:"create_at"
    int64  create_at = 8;
    // 基础数据Hash
    // @gotags: json:"resource_hash"
    string resource_hash = 10;
    // 描述数据Hash
    // @gotags: json:"describe_hash"
    string describe_hash = 11;
    // Resource信息释放有变化
    // @gotags: json:"resource_hash_changed,omitempty"
    bool resource_hash_changed = 12;
    // Describe信息释放有变化
    // @gotags: json:"describe_hash_changed,omitempty"
    bool describe_hash_changed = 13;
    // 资源所属空间
    // @gotags: json:"namespace"
    string namespace = 14;
    // 资源所属环境
    // @gotags: json:"env"
    string env = 15;
    // 使用方式
    // @gotags: json:"usage_mode"
    UsageMode usage_mode = 16;
    // 共享策略, 当一个资源被多个应用共享时, 可以指定允许的应用
    // @gotags: json:"shared_policy"
    SharedPolicy shared_policy = 17;
    // 资源所属域
    // @gotags: json:"domain"
    string domain = 18;
}

// 共享策略
message SharedPolicy {
    // 分享的维度
    // @gotags: json:"tag_key"
    string tag_key = 1;
    // 分享给哪些值
    // @gotags: json:"tag_values"
    repeated string tag_values = 2;
}

message Information {
    // 过期时间
    // @gotags: json:"expire_at"
    int64 expire_at = 1;
    // 种类
    // @gotags: json:"category"
    string category = 2;
    // 规格
    // @gotags: json:"type"
    string type = 3;
    // 名称
    // @gotags: json:"name"
    string name = 4;
    // 描述
    // @gotags: json:"description"
    string description = 5;
    // 服务商中的状态
    // @gotags: json:"status"
    string status = 6;
    // 标签
    // @gotags: json:"tags"
    repeated Tag tags = 7;
    // 更新时间
    // @gotags: json:"update_at"
    int64 update_at = 8;
    // 同步的账号
    // @gotags: json:"sync_account"
    string sync_account = 9;
    // 公网IP, 或者域名
    // @gotags: json:"public_ip"
    repeated string public_ip = 10;
    // 内网IP, 或者域名
    // @gotags: json:"private_ip"
    repeated string private_ip = 11;
    // 实例付费方式
    // @gotags: json:"pay_type"
    string pay_type = 12;
}

enum TagType {
    // 用户自定义标签, 允许用户修改
    USER = 0;
    // 第三方定义的标签, 比如云商同步过来的标签
    THIRD = 1;
    // 系统使用标签, 禁止用户修改
    SYSTEM = 2;
}

message Tag {
    // 标签属于的资源
    // @gotags: json:"resource_id"
    string resource_id = 1;
    // 标签的类型
    // @gotags: json:"type"
    TagType type = 2;
    // 标签的Key
    // @gotags: json:"key" validate:"required"
    string key = 3;
    // 标签的值
    // @gotags: json:"value" validate:"required"
    string value = 4;
    // 标签的值的描述, 通常用于展示
    // @gotags: json:"describe"
    string describe = 5;
    // 标签权重, 针对同一个key, 多个value场景, 默认值1
    // @gotags: json:"weight"
    int64 weight = 6;
    // 标签meta信息, 比如前端需要设置标签的颜色
    // @gotags: json:"meta"
    map<string,string> meta = 7;
}

message TagSet {
    // @gotags: json:"total"
    int64 total = 1;
    // @gotags: json:"items"
    repeated Tag items = 2;
}

message SearchRequest {
    // 分页参数
    // @gotags: json:"page"
    infraboard.mcube.page.PageRequest page = 1;
    // 资源所属域
    // @gotags: json:"domain"
    string domain = 2;
    // 资源所属空间
    // @gotags: json:"namespace"
    string namespace = 3;
    // 资源所属环境
    // @gotags: json:"env"
    string env = 4;
    // 使用方式
    // @gotags: json:"usage_mode"
    optional UsageMode usage_mode = 5;
    // 厂商
    // @gotags: json:"vendor"
    optional Vendor vendor = 6;
    // 同步的账号
    // @gotags: json:"sync_account"
    string sync_account = 7;
    // 资源类型
    // @gotags: json:"type"
    optional Type type = 8;
    // 服务商中的状态
    // @gotags: json:"status"
    string status = 9;
   // 账单月当时标签
    // @gotags: json:"tags"
    repeated Tag tags = 10;
    // 关键字参数
    // @gotags: json:"keywords"
    string keywords = 14;
    // 是否精确匹配
    // @gotags: json:"exact_match"
    bool exact_match = 15;
}

enum UpdateAction {
    // 添加
    ADD = 0;
    // 移除
    REMOVE = 1;
}

message UpdateTagRequest {
    // 资源id
    // @gotags: json:"id" validate:"required"
    string id = 1;
    // 更新动作
    // @gotags: json:"action"
    UpdateAction action = 2;
    // 需要添加的资源标签
    // @gotags: json:"tags" validate:"required"
    repeated Tag tags = 3;
}

message QueryTagRequest {
    // 资源id
    // @gotags: json:"resource_ids" 
    repeated string resource_ids = 1;
}

// 用户最近访问的资源统计
message LatestAccess {
    // 用户所处域
    // @gotags: json:"domain" 
    string domain = 1;
    // 用户
    // @gotags: json:"account" 
    string account = 2;
    // 资源Id
    // @gotags: json:"resource_id" 
    string resource_id = 3;
    // 最近一次访问时间
    // @gotags: json:"latest_at" 
    int64 latest_at = 4;
    // 总共访问多少次, 用于Top统计
    // @gotags: json:"total_access" 
    int64 total_access = 5;
}

// 用户收藏的资源
message Favorite {
    // 用户所处域
    // @gotags: json:"domain" 
    string domain = 1;
    // 用户
    // @gotags: json:"account" 
    string account = 2;
    // 资源Id
    // @gotags: json:"resource_id" 
    string resource_id = 3;
    // 收藏时间
    // @gotags: json:"add_at" 
    int64 add_at = 4;
}

message UpdateFavoriteRequest {
    // 用户所处域
    // @gotags: json:"domain" 
    string domain = 1;
    // 用户
    // @gotags: json:"account" 
    string account = 2;
    // 资源Id
    // @gotags: json:"resource_id" 
    string resource_id = 3;
    // 更新动作
    // @gotags: json:"action"
    UpdateAction action = 4;
}